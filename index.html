<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Criador de Cartazes - Lojas Nordestina</title>
  <style>
    /* ... (mantenha os estilos anteriores inalterados) ... */
  </style>
</head>
<body>
  <!-- Mantenha a mesma estrutura HTML anterior -->

  <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
  <script>
    let imageLoaded = false;

    function validarCampos() {
      const nome = document.getElementById('nomeProduto').value;
      const file = document.getElementById('upload').files[0];
      
      if (!file) {
        alert('Por favor, selecione uma imagem!');
        return false;
      }
      if (!nome) {
        alert('Por favor, insira o nome do produto!');
        return false;
      }
      return true;
    }

    function carregarImagem(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = function(e) {
          const img = new Image();
          img.onload = () => resolve(img);
          img.onerror = () => reject(new Error('Erro ao carregar imagem'));
          img.src = e.target.result;
        }
        reader.onerror = () => reject(new Error('Erro ao ler arquivo'));
        reader.readAsDataURL(file);
      });
    }

    async function gerarCartaz() {
      try {
        if (!validarCampos()) return;

        const file = document.getElementById('upload').files[0];
        const nome = document.getElementById('nomeProduto').value;
        const preco = document.getElementById('precoProduto').value;

        // Carregar imagem
        const img = await carregarImagem(file);
        document.getElementById('imgPreview').src = img.src;
        imageLoaded = true;

        // Atualizar textos
        document.getElementById('nomePreview').textContent = nome.toUpperCase();
        document.getElementById('precoPreview').textContent = preco ? `R$ ${parseFloat(preco).toFixed(2).replace('.', ',')` : '';

        // Mostrar cartaz
        document.getElementById('cartazFinal').style.display = 'block';
        window.scrollTo({
          top: document.getElementById('cartazFinal').offsetTop,
          behavior: 'smooth'
        });

      } catch (error) {
        alert(error.message);
      }
    }

    function formatarNomeArquivo(nome) {
      return nome.toLowerCase()
        .replace(/\s+/g, '_')
        .replace(/[^a-z0-9_]/gi, '')
        .substring(0, 30);
    }

    async function baixarCartaz() {
      try {
        if (!imageLoaded) {
          alert('Gere o cartaz primeiro antes de baixar!');
          return;
        }

        const node = document.getElementById('cartazFinal');
        const nomeProduto = formatarNomeArquivo(document.getElementById('nomeProduto').value);
        
        const canvas = await html2canvas(node, {
          scale: 2,
          useCORS: true,
          allowTaint: true
        });

        const link = document.createElement('a');
        link.download = `cartaz_${nomeProduto || 'lojasnordestina'}_${Date.now()}.png`;
        link.href = canvas.toDataURL('image/png', 1.0);
        link.click();

      } catch (error) {
        alert('Erro ao gerar o cartaz: ' + error.message);
      }
    }
  </script>
</body>
</html>
